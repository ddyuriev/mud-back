Так... Что надо сделать последовательно:

1. Запрос на js XMLHttpRequest
сделать асинхронным.

хммм

https://learn.javascript.ru/async-await

--------------------------------------------

Так... надо поставить цель.
Вижу 2 варианта:
1. Дождаться ответа ajax, только тогда все остальное
2. Через промисы, когда получили user тогда коннект.

Попробую второй вар

-------------


по поводу присвоения значения внутри promise:

https://stackoverflow.com/questions/38869197/fetch-set-variable-with-fetch-response-and-return-from-function


-------------

Вообщем, немного другая архитектура будет

На чистом js если не удачное обращение рисуем фейл.